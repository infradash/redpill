## Circle CI configuration
machine:
  services:
    - docker

  timezone:
    America/Los_Angeles

  # Override /etc/hosts
  hosts:
    circlehost: 127.0.0.1

  # Add some environment variables
  environment:
    BINARY: redpill
    GOPATH: $HOME/go
    PATH: $GOPATH/bin:$PATH
    CIRCLE_ENV: test
    BUILD_DIR: build/bin

## Customize dependencies
dependencies:
  pre:
    - go version
    - hack/get_build_info.sh

  override:
    - source ./hack/env.sh && make GODEP=godep
  post:
    - cp $BUILD_DIR/* $CIRCLE_ARTIFACTS

## Customize test commands
test:
  override:
    - source ./hack/env.sh && make GODEP=godep
    - cp $BUILD_DIR/* $CIRCLE_ARTIFACTS

## Customize deployment commands
deployment:
   git:
     branch: /release\/.*/
     commands:
       - source ./hack/env.sh && make GODEP=godep build
       - cp $BUILD_DIR/redpill $CIRCLE_ARTIFACTS
       - source ./hack/env.sh && make deploy-git

   docker:
     branch: /v[0-9]+(\.[0-9]+)*/
     commands:
       - cp $BUILD_DIR/dash docker/dash
       - cd docker/dash && make push && cd ..
